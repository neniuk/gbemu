#ifndef GB_H
#define GB_H

#include "alu.h"
#include "bmi.h"
#include "config.h"
#include "idu.h"
#include "memory.h"
#include "registers.h"
#include "screen.h"
#include "stack.h"

#include <array>
#include <stdbool.h>
#include <stdint.h>
#include <vector>

class GB {
  public:
    GB();
    Memory memory;
    Registers registers;
    Stack stack;
    Screen screen;
    IDU idu;
    ALU alu;
    BMI bmi;

    uint64_t tstates = 0;
    bool stopped = false;
    bool halted = false;
    bool ime = false;

    void load(const std::vector<uint8_t> &buf);

    using OpFn = int (GB::*)();

    struct OpInfo {
        OpFn fn;
        const char *name;
        uint8_t length;
    };

    std::array<OpInfo, 256> ops{};
    std::array<OpInfo, 256> cb_ops{};

    void exec_cb(uint8_t cb);

    void init();

    void op_unimplemented();

    void op_nop();
    void op_ld_bc_n16();
    void op_ld_bcm_a();
    void op_inc_bc();
    void op_inc_b();
    void op_dec_b();
    void op_ld_b_n8();
    void op_rlca();
    void op_ld_a16m_sp();
    void op_add_hl_bc();
    void op_ld_a_bcm();
    void op_dec_bc();
    void op_inc_c();
    void op_dec_c();
    void op_ld_c_n8();
    void op_rrca();
    void op_stop_n8();
    void op_ld_de_n16();
    void op_ld_dem_a();
    void op_inc_de();
    void op_inc_d();
    void op_dec_d();
    void op_ld_d_n8();
    void op_rla();
    void op_jr_e8();
    void op_add_hl_de();
    void op_ld_a_dem();
    void op_dec_de();
    void op_inc_e();
    void op_dec_e();
    void op_ld_e_n8();
    void op_rra();
    void op_jr_nz_e8();
    void op_ld_hl_a16();
    void op_ld_hlim_a();
    void op_inc_hl();
    void op_inc_h();
    void op_dec_h();
    void op_ld_h_n8();
    void op_daa();
    void op_jr_z_e8();
    void op_add_hl_hl();
    void op_ld_a_hlim();
    void op_dec_hl();
    void op_inc_l();
    void op_dec_l();
    void op_ld_l_n8();
    void op_cpl();
    void op_jr_nc_e8();
    void op_ld_sp_a16();
    void op_ld_hldm_a();
    void op_inc_sp();
    void op_inc_hlm();
    void op_dec_hlm();
    void op_ld_hlm_n8();
    void op_scf();
    void op_jr_c_e8();
    void op_add_hl_sp();
    void op_ld_a_hldm();
    void op_dec_sp();
    void op_inc_a();
    void op_dec_a();
    void op_ld_a_n8();
    void op_ccf();
    void op_ld_b_b();
    void op_ld_b_c();
    void op_ld_b_d();
    void op_ld_b_e();
    void op_ld_b_h();
    void op_ld_b_l();
    void op_ld_b_hlm();
    void op_ld_b_a();
    void op_ld_c_b();
    void op_ld_c_c();
    void op_ld_c_d();
    void op_ld_c_e();
    void op_ld_c_h();
    void op_ld_c_l();
    void op_ld_c_hlm();
    void op_ld_c_a();
    void op_ld_d_b();
    void op_ld_d_c();
    void op_ld_d_d();
    void op_ld_d_e();
    void op_ld_d_h();
    void op_ld_d_l();
    void op_ld_d_hlm();
    void op_ld_d_a();
    void op_ld_e_b();
    void op_ld_e_c();
    void op_ld_e_d();
    void op_ld_e_e();
    void op_ld_e_h();
    void op_ld_e_l();
    void op_ld_e_hlm();
    void op_ld_e_a();
    void op_ld_h_b();
    void op_ld_h_c();
    void op_ld_h_d();
    void op_ld_h_e();
    void op_ld_h_h();
    void op_ld_h_l();
    void op_ld_h_hlm();
    void op_ld_h_a();
    void op_ld_l_b();
    void op_ld_l_c();
    void op_ld_l_d();
    void op_ld_l_e();
    void op_ld_l_h();
    void op_ld_l_l();
    void op_ld_l_hlm();
    void op_ld_l_a();
    void op_ld_hlm_b();
    void op_ld_hlm_c();
    void op_ld_hlm_d();
    void op_ld_hlm_e();
    void op_ld_hlm_h();
    void op_ld_hlm_l();
    void op_halt();
    void op_ld_hlm_a();
    void op_ld_a_b();
    void op_ld_a_c();
    void op_ld_a_d();
    void op_ld_a_e();
    void op_ld_a_h();
    void op_ld_a_l();
    void op_ld_a_hlm();
    void op_ld_a_a();
    void op_add_a_b();
    void op_add_a_c();
    void op_add_a_d();
    void op_add_a_e();
    void op_add_a_h();
    void op_add_a_l();
    void op_add_a_hlm();
    void op_add_a_a();
    void op_adc_a_b();
    void op_adc_a_c();
    void op_adc_a_d();
    void op_adc_a_e();
    void op_adc_a_h();
    void op_adc_a_l();
    void op_adc_a_hlm();
    void op_adc_a_a();
    void op_sub_a_b();
    void op_sub_a_c();
    void op_sub_a_d();
    void op_sub_a_e();
    void op_sub_a_h();
    void op_sub_a_l();
    void op_sub_a_hlm();
    void op_sub_a_a();
    void op_sbc_a_b();
    void op_sbc_a_c();
    void op_sbc_a_d();
    void op_sbc_a_e();
    void op_sbc_a_h();
    void op_sbc_a_l();
    void op_sbc_a_hlm();
    void op_sbc_a_a();
    void op_and_a_b();
    void op_and_a_c();
    void op_and_a_d();
    void op_and_a_e();
    void op_and_a_h();
    void op_and_a_l();
    void op_and_a_hlm();
    void op_and_a_a();
    void op_xor_a_b();
    void op_xor_a_c();
    void op_xor_a_d();
    void op_xor_a_e();
    void op_xor_a_h();
    void op_xor_a_l();
    void op_xor_a_hlm();
    void op_xor_a_a();
    void op_or_a_b();
    void op_or_a_c();
    void op_or_a_d();
    void op_or_a_e();
    void op_or_a_h();
    void op_or_a_l();
    void op_or_a_hlm();
    void op_or_a_a();
    void op_cp_a_b();
    void op_cp_a_c();
    void op_cp_a_d();
    void op_cp_a_e();
    void op_cp_a_h();
    void op_cp_a_l();
    void op_cp_a_hlm();
    void op_cp_a_a();
    void op_ret_nz();
    void op_pop_bc();
    void op_jp_nz_a16();
    void op_jp_a16();
    void op_call_nz_a16();
    void op_push_bc();
    void op_add_a_n8();
    void op_rst_00();
    void op_ret_z();
    void op_ret();
    void op_jp_z_a16();
    void op_prefix();
    void op_call_z_a16();
    void op_call_a16();
    void op_adc_a_n8();
    void op_rst_08();
    void op_ret_nc();
    void op_pop_de();
    void op_jp_nc_a16();
    void op_undefined_d3();
    void op_call_nc_a16();
    void op_push_de();
    void op_sub_a_n8();
    void op_rst_10();
    void op_ret_c();
    void op_reti();
    void op_jp_c_a16();
    void op_unused_db();
    void op_call_c_a16();
    void op_unused_dd();
    void op_sbc_a_n8();
    void op_rst_18();
    void op_ldh_a8m_a();
    void op_pop_hl();
    void op_ldh_cm_a();
    void op_unused_e3();
    void op_unused_e4();
    void op_push_hl();
    void op_and_a_n8();
    void op_rst_20();
    void op_add_sp_e8();
    void op_jp_hl();
    void op_ld_a16m_a();
    void op_unused_eb();
    void op_unused_ec();
    void op_unused_ed();
    void op_xor_a_n8();
    void op_rst_28();
    void op_ldh_a_a8m();
    void op_pop_af();
    void op_ldh_a_cm();
    void op_di();
    void op_unused_f4();
    void op_push_af();
    void op_or_a_n8();
    void op_rst_30();
    void op_ld_hl_sp_e8();
    void op_ld_sp_hl();
    void op_ld_a_a16m();
    void op_ei();
    void op_unused_fc();
    void op_unused_fd();
    void op_cp_a_n8();
    void op_rst_38();

    // CB-prefixed instructions
    void op_cb_rlc_b();
    void op_cb_rlc_c();
    void op_cb_rlc_d();
    void op_cb_rlc_e();
    void op_cb_rlc_h();
    void op_cb_rlc_l();
    void op_cb_rlc_hlm();
    void op_cb_rlc_a();
    void op_cb_rrc_b();
    void op_cb_rrc_c();
    void op_cb_rrc_d();
    void op_cb_rrc_e();
    void op_cb_rrc_h();
    void op_cb_rrc_l();
    void op_cb_rrc_hlm();
    void op_cb_rrc_a();
    void op_cb_rl_b();
    void op_cb_rl_c();
    void op_cb_rl_d();
    void op_cb_rl_e();
    void op_cb_rl_h();
    void op_cb_rl_l();
    void op_cb_rl_hlm();
    void op_cb_rl_a();
    void op_cb_rr_b();
    void op_cb_rr_c();
    void op_cb_rr_d();
    void op_cb_rr_e();
    void op_cb_rr_h();
    void op_cb_rr_l();
    void op_cb_rr_hlm();
    void op_cb_rr_a();
    void op_cb_sla_b();
    void op_cb_sla_c();
    void op_cb_sla_d();
    void op_cb_sla_e();
    void op_cb_sla_h();
    void op_cb_sla_l();
    void op_cb_sla_hlm();
    void op_cb_sla_a();
    void op_cb_sra_b();
    void op_cb_sra_c();
    void op_cb_sra_d();
    void op_cb_sra_e();
    void op_cb_sra_h();
    void op_cb_sra_l();
    void op_cb_sra_hlm();
    void op_cb_sra_a();
    void op_cb_swap_b();
    void op_cb_swap_c();
    void op_cb_swap_d();
    void op_cb_swap_e();
    void op_cb_swap_h();
    void op_cb_swap_l();
    void op_cb_swap_hlm();
    void op_cb_swap_a();
    void op_cb_srl_b();
    void op_cb_srl_c();
    void op_cb_srl_d();
    void op_cb_srl_e();
    void op_cb_srl_h();
    void op_cb_srl_l();
    void op_cb_srl_hlm();
    void op_cb_srl_a();
    void op_cb_bit_0_b();
    void op_cb_bit_0_c();
    void op_cb_bit_0_d();
    void op_cb_bit_0_e();
    void op_cb_bit_0_h();
    void op_cb_bit_0_l();
    void op_cb_bit_0_hlm();
    void op_cb_bit_0_a();
    void op_cb_bit_1_b();
    void op_cb_bit_1_c();
    void op_cb_bit_1_d();
    void op_cb_bit_1_e();
    void op_cb_bit_1_h();
    void op_cb_bit_1_l();
    void op_cb_bit_1_hlm();
    void op_cb_bit_1_a();
    void op_cb_bit_2_b();
    void op_cb_bit_2_c();
    void op_cb_bit_2_d();
    void op_cb_bit_2_e();
    void op_cb_bit_2_h();
    void op_cb_bit_2_l();
    void op_cb_bit_2_hlm();
    void op_cb_bit_2_a();
    void op_cb_bit_3_b();
    void op_cb_bit_3_c();
    void op_cb_bit_3_d();
    void op_cb_bit_3_e();
    void op_cb_bit_3_h();
    void op_cb_bit_3_l();
    void op_cb_bit_3_hlm();
    void op_cb_bit_3_a();
    void op_cb_bit_4_b();
    void op_cb_bit_4_c();
    void op_cb_bit_4_d();
    void op_cb_bit_4_e();
    void op_cb_bit_4_h();
    void op_cb_bit_4_l();
    void op_cb_bit_4_hlm();
    void op_cb_bit_4_a();
    void op_cb_bit_5_b();
    void op_cb_bit_5_c();
    void op_cb_bit_5_d();
    void op_cb_bit_5_e();
    void op_cb_bit_5_h();
    void op_cb_bit_5_l();
    void op_cb_bit_5_hlm();
    void op_cb_bit_5_a();
    void op_cb_bit_6_b();
    void op_cb_bit_6_c();
    void op_cb_bit_6_d();
    void op_cb_bit_6_e();
    void op_cb_bit_6_h();
    void op_cb_bit_6_l();
    void op_cb_bit_6_hlm();
    void op_cb_bit_6_a();
    void op_cb_bit_7_b();
    void op_cb_bit_7_c();
    void op_cb_bit_7_d();
    void op_cb_bit_7_e();
    void op_cb_bit_7_h();
    void op_cb_bit_7_l();
    void op_cb_bit_7_hlm();
    void op_cb_bit_7_a();
    void op_cb_res_0_b();
    void op_cb_res_0_c();
    void op_cb_res_0_d();
    void op_cb_res_0_e();
    void op_cb_res_0_h();
    void op_cb_res_0_l();
    void op_cb_res_0_hlm();
    void op_cb_res_0_a();
    void op_cb_res_1_b();
    void op_cb_res_1_c();
    void op_cb_res_1_d();
    void op_cb_res_1_e();
    void op_cb_res_1_h();
    void op_cb_res_1_l();
    void op_cb_res_1_hlm();
    void op_cb_res_1_a();
    void op_cb_res_2_b();
    void op_cb_res_2_c();
    void op_cb_res_2_d();
    void op_cb_res_2_e();
    void op_cb_res_2_h();
    void op_cb_res_2_l();
    void op_cb_res_2_hlm();
    void op_cb_res_2_a();
    void op_cb_res_3_b();
    void op_cb_res_3_c();
    void op_cb_res_3_d();
    void op_cb_res_3_e();
    void op_cb_res_3_h();
    void op_cb_res_3_l();
    void op_cb_res_3_hlm();
    void op_cb_res_3_a();
    void op_cb_res_4_b();
    void op_cb_res_4_c();
    void op_cb_res_4_d();
    void op_cb_res_4_e();
    void op_cb_res_4_h();
    void op_cb_res_4_l();
    void op_cb_res_4_hlm();
    void op_cb_res_4_a();
    void op_cb_res_5_b();
    void op_cb_res_5_c();
    void op_cb_res_5_d();
    void op_cb_res_5_e();
    void op_cb_res_5_h();
    void op_cb_res_5_l();
    void op_cb_res_5_hlm();
    void op_cb_res_5_a();
    void op_cb_res_6_b();
    void op_cb_res_6_c();
    void op_cb_res_6_d();
    void op_cb_res_6_e();
    void op_cb_res_6_h();
    void op_cb_res_6_l();
    void op_cb_res_6_hlm();
    void op_cb_res_6_a();
    void op_cb_res_7_b();
    void op_cb_res_7_c();
    void op_cb_res_7_d();
    void op_cb_res_7_e();
    void op_cb_res_7_h();
    void op_cb_res_7_l();
    void op_cb_res_7_hlm();
    void op_cb_res_7_a();
    void op_cb_set_0_b();
    void op_cb_set_0_c();
    void op_cb_set_0_d();
    void op_cb_set_0_e();
    void op_cb_set_0_h();
    void op_cb_set_0_l();
    void op_cb_set_0_hlm();
    void op_cb_set_0_a();
    void op_cb_set_1_b();
    void op_cb_set_1_c();
    void op_cb_set_1_d();
    void op_cb_set_1_e();
    void op_cb_set_1_h();
    void op_cb_set_1_l();
    void op_cb_set_1_hlm();
    void op_cb_set_1_a();
    void op_cb_set_2_b();
    void op_cb_set_2_c();
    void op_cb_set_2_d();
    void op_cb_set_2_e();
    void op_cb_set_2_h();
    void op_cb_set_2_l();
    void op_cb_set_2_hlm();
    void op_cb_set_2_a();
    void op_cb_set_3_b();
    void op_cb_set_3_c();
    void op_cb_set_3_d();
    void op_cb_set_3_e();
    void op_cb_set_3_h();
    void op_cb_set_3_l();
    void op_cb_set_3_hlm();
    void op_cb_set_3_a();
    void op_cb_set_4_b();
    void op_cb_set_4_c();
    void op_cb_set_4_d();
    void op_cb_set_4_e();
    void op_cb_set_4_h();
    void op_cb_set_4_l();
    void op_cb_set_4_hlm();
    void op_cb_set_4_a();
    void op_cb_set_5_b();
    void op_cb_set_5_c();
    void op_cb_set_5_d();
    void op_cb_set_5_e();
    void op_cb_set_5_h();
    void op_cb_set_5_l();
    void op_cb_set_5_hlm();
    void op_cb_set_5_a();
    void op_cb_set_6_b();
    void op_cb_set_6_c();
    void op_cb_set_6_d();
    void op_cb_set_6_e();
    void op_cb_set_6_h();
    void op_cb_set_6_l();
    void op_cb_set_6_hlm();
    void op_cb_set_6_a();
    void op_cb_set_7_b();
    void op_cb_set_7_c();
    void op_cb_set_7_d();
    void op_cb_set_7_e();
    void op_cb_set_7_h();
    void op_cb_set_7_l();
    void op_cb_set_7_hlm();
    void op_cb_set_7_a();
};

#endif
